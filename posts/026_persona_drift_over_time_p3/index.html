<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Eric Zou">
<meta name="dcterms.date" content="2025-12-14">
<meta name="description" content="Tracking persona stability in a spatial environment over 30 iterations">

<title>Persona Drift in the 2D World – My Explorations with LLMs in Social Contexts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-0b37c64f34216b628666a8dac638b53b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">My Explorations with LLMs in Social Contexts</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ezou626"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/EDubsZ123"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Persona Drift in the 2D World</h1>
                  <div>
        <div class="description">
          Tracking persona stability in a spatial environment over 30 iterations
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">LLMs</div>
                <div class="quarto-category">Conversations</div>
                <div class="quarto-category">Personas</div>
                <div class="quarto-category">Simulation</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Eric Zou </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 14, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="personas-in-space" class="level1">
<h1>Personas in Space</h1>
<p>In post 020, we tracked persona drift in text-only conversations. But what happens when agents exist in a <strong>2D spatial world</strong>? Does spatial context affect persona stability?</p>
<p>This post combines: - <strong>2D world simulation</strong> (from post 017): Agents move and interact spatially - <strong>Persona drift tracking</strong> (from post 020): ConvoKit metrics over time - <strong>30 iterations</strong>: Enough to see drift patterns - <strong>2 and 4 speakers</strong>: Compare small vs medium groups</p>
<section id="the-question" class="level2">
<h2 class="anchored" data-anchor-id="the-question">The Question</h2>
<p>Does spatial context make personas more or less stable? Does proximity affect how agents communicate? Do agents develop spatial behaviors that influence their personas?</p>
</section>
<section id="setup-and-imports" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-imports">Setup and Imports</h2>
<div id="dcbf71f1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> random <span class="im">import</span> random, randint, shuffle</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ConvoKit imports</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> Corpus, Utterance, Speaker</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit.text_processing <span class="im">import</span> TextParser</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> convokit <span class="im">import</span> PolitenessStrategies</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>load_dotenv(<span class="st">"../../.env"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> OpenAI()</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>GRID_SIZE <span class="op">=</span> <span class="dv">20</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="d-world-agent-class" class="level2">
<h2 class="anchored" data-anchor-id="d-world-agent-class">2D World Agent Class</h2>
<p>We’ll use the Agent class from post 017 that supports spatial movement.</p>
<div id="89e31545" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Agent:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    y: <span class="bu">int</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    color: <span class="bu">str</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    history: <span class="bu">list</span> <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> move(<span class="va">self</span>, dx, dy):</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, <span class="bu">min</span>(GRID_SIZE<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.x <span class="op">+</span> dx))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.y <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, <span class="bu">min</span>(GRID_SIZE<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.y <span class="op">+</span> dy))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_position(<span class="va">self</span>):</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">self</span>.x, <span class="va">self</span>.y)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> distance_to(<span class="va">self</span>, other):</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate Euclidean distance to another agent."""</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.sqrt((<span class="va">self</span>.x <span class="op">-</span> other.x)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (<span class="va">self</span>.y <span class="op">-</span> other.y)<span class="op">**</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="d-world-conversation-runner" class="level2">
<h2 class="anchored" data-anchor-id="d-world-conversation-runner">2D World Conversation Runner</h2>
<p>This combines spatial movement with conversation, tracking both over 30 iterations.</p>
<div id="ded25c54" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_2d_world_conversation(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    iterations: <span class="bu">int</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    participant_count: <span class="bu">int</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    evaluation_interval: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[List[Dict], List[Dict], List[Dict]]:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Run conversation in 2D world with spatial movement.</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns (conversation_history, metric_history, position_history)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    conversation_history <span class="op">=</span> []</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    metric_history <span class="op">=</span> []</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    position_history <span class="op">=</span> []</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize agents in 2D space</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    agents <span class="op">=</span> []</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(participant_count):</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Spread agents across the grid</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> randint(<span class="dv">0</span>, GRID_SIZE <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> randint(<span class="dv">0</span>, GRID_SIZE <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        agents.append(Agent(<span class="ss">f"speaker_</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, x, y, <span class="ss">f"color_</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    identity_summaries <span class="op">=</span> {}</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap identities</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> agent <span class="kw">in</span> agents:</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        bootstrap_messages <span class="op">=</span> [</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"role"</span>: <span class="st">"system"</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"content"</span>: (</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"You are </span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> in a group conversation among "</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"other people's avatars in a 2D virtual world. "</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"You can move around and interact with others. "</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Imagine your own background, priorities, and communication "</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"style. First, in 2-3 sentences, describe who you are and "</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"what you care about."</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>bootstrap_messages,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>            store<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        first_message <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        identity_summaries[agent.name] <span class="op">=</span> first_message</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        conversation_history.append(</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"name"</span>: agent.name, <span class="st">"content"</span>: first_message}</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Record initial positions</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    position_history.append({</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        agent.name: (agent.x, agent.y) <span class="cf">for</span> agent <span class="kw">in</span> agents</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_agent_action(agent: Agent, all_agents: List[Agent], transcript: List[<span class="bu">str</span>]):</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get action for an agent in the 2D world."""</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        others <span class="op">=</span> [a <span class="cf">for</span> a <span class="kw">in</span> all_agents <span class="cf">if</span> a <span class="op">!=</span> agent]</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        others_loc <span class="op">=</span> <span class="st">"</span><span class="ch">\\</span><span class="st">n"</span>.join([<span class="ss">f"- </span><span class="sc">{</span>a<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: (</span><span class="sc">{</span>a<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>a<span class="sc">.</span>y<span class="sc">}</span><span class="ss">)"</span> <span class="cf">for</span> a <span class="kw">in</span> others])</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate distances</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>        nearby <span class="op">=</span> [a <span class="cf">for</span> a <span class="kw">in</span> others <span class="cf">if</span> agent.distance_to(a) <span class="op">&lt;=</span> <span class="dv">5</span>]</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>        nearby_info <span class="op">=</span> <span class="st">"</span><span class="ch">\\</span><span class="st">n"</span>.join([<span class="ss">f"- </span><span class="sc">{</span>a<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: (</span><span class="sc">{</span>a<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>a<span class="sc">.</span>y<span class="sc">}</span><span class="ss">), distance </span><span class="sc">{</span>agent<span class="sc">.</span>distance_to(a)<span class="sc">:.1f}</span><span class="ss">"</span> <span class="cf">for</span> a <span class="kw">in</span> nearby])</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> nearby_info:</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>            nearby_info <span class="op">=</span> <span class="st">"None (you are alone)"</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        system_prompt <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="ss">You have just joined an online multiplayer chatroom as an avatar in a 2D grid. Discuss any topic, including those beyond the grid.</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="ss">You are </span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">, positioned at (</span><span class="sc">{</span>agent<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>agent<span class="sc">.</span>y<span class="sc">}</span><span class="ss">) in a 20x20 grid.</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="ss">Other avatars currently visible:</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>others_loc<span class="sc">}</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="ss">Nearby avatars (within 5 units):</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>nearby_info<span class="sc">}</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="ss">Recent chat messages:</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span><span class="bu">chr</span>(<span class="dv">10</span>)<span class="sc">.</span>join(transcript[<span class="op">-</span><span class="dv">3</span>:]) <span class="cf">if</span> transcript <span class="cf">else</span> <span class="st">"No messages yet."</span><span class="sc">}</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="ss">You can do BOTH:</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="ss">1. Move your avatar using [MOVE: DIRECTION] (UP, DOWN, LEFT, RIGHT)</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="ss">2. Chat about anything - the grid, your position, or any topic you want</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="ss">You can move and speak in the same turn. Format: [MOVE: DIRECTION] followed by your message, or just speak without moving.</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="ss">Keep your response short (1-2 sentences).</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_prompt}]</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content.strip()</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse movement</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>        direction <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>        match <span class="op">=</span> re.search(<span class="vs">r'</span><span class="ch">\[</span><span class="vs">MOVE:</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="dv">\w</span><span class="op">+</span><span class="kw">)</span><span class="ch">\]</span><span class="vs">'</span>, content)</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> match:</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>            direction <span class="op">=</span> match.group(<span class="dv">1</span>).upper()</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> direction <span class="op">==</span> <span class="st">"UP"</span>: agent.move(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"DOWN"</span>: agent.move(<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"LEFT"</span>: agent.move(<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"RIGHT"</span>: agent.move(<span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract message</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>        message <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="ch">\[</span><span class="vs">MOVE:</span><span class="dv">\s</span><span class="op">*</span><span class="dv">\w</span><span class="op">+</span><span class="ch">\]</span><span class="vs">'</span>, <span class="st">''</span>, content).strip()</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> message:</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>            transcript.append(<span class="ss">f"</span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>            conversation_history.append(</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"name"</span>: agent.name, <span class="st">"content"</span>: message}</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run iterations</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    transcript <span class="op">=</span> []</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> tqdm(<span class="bu">range</span>(iterations), desc<span class="op">=</span><span class="ss">f"Running </span><span class="sc">{</span>participant_count<span class="sc">}</span><span class="ss">-speaker 2D conversation"</span>):</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Shuffle agent order each round</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>        shuffled_agents <span class="op">=</span> agents.copy()</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>        shuffle(shuffled_agents)</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Each agent acts</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> agent <span class="kw">in</span> shuffled_agents:</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> random() <span class="op">&lt;</span> <span class="fl">0.7</span>:  <span class="co"># 70% chance to act</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>                get_agent_action(agent, agents, transcript)</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Record positions</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>        position_history.append({</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>            agent.name: (agent.x, agent.y) <span class="cf">for</span> agent <span class="kw">in</span> agents</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate metrics at intervals</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> evaluation_interval <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Evaluate using the function defined below</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>            corpus <span class="op">=</span> conversation_to_corpus(conversation_history)</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>            metrics <span class="op">=</span> {</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>                <span class="st">"dynamic"</span>: compute_dynamic_score(corpus),</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>                <span class="st">"conclusiveness"</span>: compute_conclusiveness_score(corpus),</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>                <span class="st">"speaker_identity"</span>: compute_speaker_identity_score(corpus),</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>                <span class="st">"speaker_fluidity"</span>: compute_speaker_fluidity_score(corpus),</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>                <span class="st">"round"</span>: i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>            metric_history.append(metrics)</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> conversation_history, metric_history, position_history</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c4657419" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conversation_to_corpus(conversation_history: List[Dict]) <span class="op">-&gt;</span> Corpus:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert conversation history to a ConvoKit Corpus."""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    utterances <span class="op">=</span> []</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, msg <span class="kw">in</span> <span class="bu">enumerate</span>(conversation_history):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> msg.get(<span class="st">"role"</span>) <span class="op">==</span> <span class="st">"assistant"</span> <span class="kw">and</span> <span class="st">"name"</span> <span class="kw">in</span> msg:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            speaker_id <span class="op">=</span> msg[<span class="st">"name"</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            text <span class="op">=</span> msg[<span class="st">"content"</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            utterance <span class="op">=</span> Utterance(</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                <span class="bu">id</span><span class="op">=</span><span class="ss">f"utt_</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                speaker<span class="op">=</span>Speaker(<span class="bu">id</span><span class="op">=</span>speaker_id),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                text<span class="op">=</span>text</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            utterance.meta[<span class="st">"timestamp"</span>] <span class="op">=</span> idx</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            utterances.append(utterance)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Corpus(utterances<span class="op">=</span>utterances)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_dynamic_score(corpus: Corpus) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Dynamic: Collaborative (1) vs. Competitive (10)"""</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        parser <span class="op">=</span> TextParser()</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        text_corpus <span class="op">=</span> parser.transform(corpus)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        ps <span class="op">=</span> PolitenessStrategies()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        ps_corpus <span class="op">=</span> ps.transform(text_corpus)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        politeness_scores <span class="op">=</span> []</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> ps_corpus.iter_utterances():</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            ps_score <span class="op">=</span> utt.meta.get(<span class="st">"politeness_strategies"</span>, {})</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            positive_markers <span class="op">=</span> <span class="bu">sum</span>([</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                ps_score.get(<span class="st">"feature_politeness_==HASPOSITIVE=="</span>, <span class="dv">0</span>),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                ps_score.get(<span class="st">"feature_politeness_==HASNEGATIVE=="</span>, <span class="dv">0</span>) <span class="op">*</span> <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>            politeness_scores.append(positive_markers)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        avg_politeness <span class="op">=</span> np.mean(politeness_scores) <span class="cf">if</span> politeness_scores <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        avg_politeness_normalized <span class="op">=</span> <span class="bu">min</span>(<span class="fl">1.0</span>, <span class="bu">max</span>(<span class="fl">0.0</span>, avg_politeness <span class="op">/</span> <span class="fl">5.0</span>))</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        speaker_counts <span class="op">=</span> defaultdict(<span class="bu">int</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> corpus.iter_utterances():</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            speaker_counts[utt.speaker.<span class="bu">id</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(speaker_counts) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="bu">sum</span>(speaker_counts.values())</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> [count <span class="op">/</span> total <span class="cf">for</span> count <span class="kw">in</span> speaker_counts.values()]</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        entropy <span class="op">=</span> <span class="op">-</span><span class="bu">sum</span>(p <span class="op">*</span> np.log2(p) <span class="cf">for</span> p <span class="kw">in</span> probs <span class="cf">if</span> p <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        max_entropy <span class="op">=</span> np.log2(<span class="bu">len</span>(speaker_counts))</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        balance_score <span class="op">=</span> entropy <span class="op">/</span> max_entropy <span class="cf">if</span> max_entropy <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        combined <span class="op">=</span> (avg_politeness_normalized <span class="op">+</span> balance_score) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="dv">10</span> <span class="op">-</span> (combined <span class="op">*</span> <span class="dv">9</span>)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(<span class="dv">10</span>, score))</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error computing dynamic score: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_conclusiveness_score(corpus: Corpus) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Conclusiveness: Consensus (1) vs. Divergence (10)"""</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if corpus is valid</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> corpus <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get utterances directly without Coordination transformer (more reliable)</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>            utterances <span class="op">=</span> <span class="bu">list</span>(corpus.iter_utterances())</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">AttributeError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(utterances) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Expanded agreement markers (using word boundaries to avoid false positives)</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Strong agreement markers</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        strong_agreement_patterns <span class="op">=</span> [</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">agree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">agreed</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">agreeing</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">agreement</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">exactly</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">absolutely</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">definitely</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">certainly</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">indeed</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">precisely</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">correct</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">right</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">true</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s right</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s correct</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i agree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">we agree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i completely agree</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">exactly right</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">spot on</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">well said</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">perfect</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">excellent point</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s exactly</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">absolutely right</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">definitely right</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">completely agree</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">wholeheartedly</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">unquestionably</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">without doubt</span><span class="dv">\b</span><span class="vs">'</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Moderate agreement markers</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        moderate_agreement_patterns <span class="op">=</span> [</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">yes</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">yeah</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">yep</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">yup</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">sure</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">okay</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">ok</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that makes sense</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s a good point</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">good point</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i see</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i understand</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i get it</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i follow</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s fair</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">fair enough</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s reasonable</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i think so</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i believe so</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">probably</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">likely</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">similar</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">similarly</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">likewise</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">same here</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">me too</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">same</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">concur</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">concurring</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">valid</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">valid point</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">sound</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">sound point</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">helpful</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">useful</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">insightful</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">interesting</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s interesting</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">good idea</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">good thinking</span><span class="dv">\b</span><span class="vs">'</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Strong disagreement markers</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>        strong_disagreement_patterns <span class="op">=</span> [</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">disagree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">disagreed</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">disagreeing</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">disagreement</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">dispute</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">disputing</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">differ</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">differed</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">differing</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">wrong</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">incorrect</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not correct</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not right</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not true</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s wrong</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">that</span><span class="ch">\'</span><span class="op">?</span><span class="vs">s incorrect</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i disagree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">we disagree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">i strongly disagree</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">don</span><span class="ch">\'</span><span class="op">?</span><span class="vs">t agree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">doesn</span><span class="ch">\'</span><span class="op">?</span><span class="vs">t agree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">didn</span><span class="ch">\'</span><span class="op">?</span><span class="vs">t agree</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">can</span><span class="ch">\'</span><span class="op">?</span><span class="vs">t agree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">cannot agree</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">won</span><span class="ch">\'</span><span class="op">?</span><span class="vs">t agree</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">object</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">objection</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">challenge</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">challenging</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">contradict</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">contradicting</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">contradiction</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">false</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">untrue</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">mistaken</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">error</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">flawed</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">problematic</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">unacceptable</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">unreasonable</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">absurd</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">ridiculous</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">outrageous</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">unfounded</span><span class="dv">\b</span><span class="vs">'</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Moderate disagreement markers (more context-dependent)</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>        moderate_disagreement_patterns <span class="op">=</span> [</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">however</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">although</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">but</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">though</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">whereas</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not necessarily</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not quite</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not exactly</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not really</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not entirely</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not completely</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not fully</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">partially</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">partly</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">somewhat</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">to some extent</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">contrary</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">conversely</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">on the other hand</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">contrast</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">contrasting</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">unlike</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">different</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">differently</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">alternative</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">alternatively</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">actually</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">in fact</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">in reality</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">the reality is</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">well</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">wait</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">hold on</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not so fast</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not sure</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not certain</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">uncertain</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">doubtful</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">questionable</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">debatable</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">arguable</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">maybe not</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">perhaps not</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">possibly not</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">not convinced</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">skeptical</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">skepticism</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">concern</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">concerned</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">issue</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">problem</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">problems</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">concern</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">worry</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">worried</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">hesitant</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">hesitation</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">dispute</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">question</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">questions</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">challenge</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">disagree with</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">differ from</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">contrary to</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">in contrast</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">by contrast</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">unlike</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">versus</span><span class="dv">\b</span><span class="vs">'</span>,</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'</span><span class="dv">\b</span><span class="vs">vs</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">compared to</span><span class="dv">\b</span><span class="vs">'</span>, <span class="vs">r'</span><span class="dv">\b</span><span class="vs">compared with</span><span class="dv">\b</span><span class="vs">'</span></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Count markers with word boundary matching</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>        strong_agreement_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>        moderate_agreement_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>        strong_disagreement_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>        moderate_disagreement_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> utterances:</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Safely get text</span></span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(utt, <span class="st">'text'</span>) <span class="kw">or</span> <span class="kw">not</span> utt.text:</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>                text_lower <span class="op">=</span> <span class="bu">str</span>(utt.text).lower()</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> (<span class="pp">AttributeError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count strong agreement (once per utterance)</span></span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>            found_strong_agree <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> pattern <span class="kw">in</span> strong_agreement_patterns:</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> re.search(pattern, text_lower):</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>                        strong_agreement_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>                        found_strong_agree <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count moderate agreement (only if no strong agreement found)</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> found_strong_agree:</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> pattern <span class="kw">in</span> moderate_agreement_patterns:</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> re.search(pattern, text_lower):</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>                            moderate_agreement_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count strong disagreement (once per utterance)</span></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>            found_strong_disagree <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> pattern <span class="kw">in</span> strong_disagreement_patterns:</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> re.search(pattern, text_lower):</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>                        strong_disagreement_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>                        found_strong_disagree <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count moderate disagreement (only if no strong disagreement found)</span></span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> found_strong_disagree:</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> pattern <span class="kw">in</span> moderate_disagreement_patterns:</span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> re.search(pattern, text_lower):</span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>                            moderate_disagreement_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Weighted counts (strong markers count more)</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>        total_agreement <span class="op">=</span> strong_agreement_count <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> moderate_agreement_count</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>        total_disagreement <span class="op">=</span> strong_disagreement_count <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> moderate_disagreement_count</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle edge cases</span></span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_agreement <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> total_disagreement <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> total_disagreement <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> total_agreement <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">10.0</span></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate ratio and score using logarithmic scaling</span></span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>        agreement_ratio <span class="op">=</span> total_agreement <span class="op">/</span> total_disagreement</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map ratio to 1-10 scale using logarithmic scaling for smoother transitions</span></span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> math</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> agreement_ratio <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>            log_ratio <span class="op">=</span> math.log(agreement_ratio)</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Map log_ratio from [-2.3, 2.3] to [10, 1]</span></span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>            <span class="co"># When log_ratio = 0 (ratio = 1.0), score = 5.0</span></span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> log_ratio <span class="op">&gt;=</span> <span class="dv">0</span>:</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Consensus range: log_ratio [0, 2.3] -&gt; score [5.0, 1.0]</span></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>                score <span class="op">=</span> <span class="fl">5.0</span> <span class="op">-</span> (log_ratio <span class="op">/</span> <span class="fl">2.3</span>) <span class="op">*</span> <span class="fl">4.0</span></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Divergence range: log_ratio [-2.3, 0] -&gt; score [10.0, 5.0]</span></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>                score <span class="op">=</span> <span class="fl">5.0</span> <span class="op">-</span> (log_ratio <span class="op">/</span> <span class="fl">2.3</span>) <span class="op">*</span> <span class="fl">5.0</span></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> <span class="fl">10.0</span></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="bu">max</span>(<span class="fl">1.0</span>, <span class="bu">min</span>(<span class="fl">10.0</span>, score))</span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> score</span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error computing conclusiveness score: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_speaker_identity_score(corpus: Corpus) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Speaker Identity: Similarity (1) vs. Diversity (10)"""</span></span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #region agent log</span></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"B"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_identity_score:entry"</span>,<span class="st">"message"</span>:<span class="st">"Function entry"</span>,<span class="st">"data"</span>:{<span class="st">"corpus_size"</span>:<span class="bu">len</span>(<span class="bu">list</span>(corpus.iter_utterances())) <span class="cf">if</span> corpus <span class="cf">else</span> <span class="dv">0</span>},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #endregion</span></span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>        speakers <span class="op">=</span> {}</span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> corpus.iter_utterances():</span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>            speaker_id <span class="op">=</span> utt.speaker.<span class="bu">id</span></span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> speaker_id <span class="kw">not</span> <span class="kw">in</span> speakers:</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>                speakers[speaker_id] <span class="op">=</span> {<span class="st">"words"</span>: <span class="bu">set</span>()}</span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>            words <span class="op">=</span> <span class="bu">set</span>(re.findall(<span class="vs">r'</span><span class="dv">\b\w</span><span class="op">+</span><span class="dv">\b</span><span class="vs">'</span>, utt.text.lower()))</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>            speakers[speaker_id][<span class="st">"words"</span>].update(words)</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"B"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_identity_score:after_collect"</span>,<span class="st">"message"</span>:<span class="st">"After collecting words"</span>,<span class="st">"data"</span>:{<span class="st">"num_speakers"</span>:<span class="bu">len</span>(speakers),<span class="st">"speaker_word_counts"</span>:{k:<span class="bu">len</span>(v[<span class="st">"words"</span>]) <span class="cf">for</span> k,v <span class="kw">in</span> speakers.items()}},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(speakers) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #region agent log</span></span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"B"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_identity_score:early_return"</span>,<span class="st">"message"</span>:<span class="st">"Early return: &lt;2 speakers"</span>,<span class="st">"data"</span>:{<span class="st">"num_speakers"</span>:<span class="bu">len</span>(speakers)},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #endregion</span></span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>        speaker_list <span class="op">=</span> <span class="bu">list</span>(speakers.keys())</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>        overlaps <span class="op">=</span> []</span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(speaker_list)):</span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(speaker_list)):</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>                words_i <span class="op">=</span> speakers[speaker_list[i]][<span class="st">"words"</span>]</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>                words_j <span class="op">=</span> speakers[speaker_list[j]][<span class="st">"words"</span>]</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(words_i) <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> <span class="bu">len</span>(words_j) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>                overlap <span class="op">=</span> <span class="bu">len</span>(words_i <span class="op">&amp;</span> words_j) <span class="op">/</span> <span class="bu">len</span>(words_i <span class="op">|</span> words_j)</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>                overlaps.append(overlap)</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"B"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_identity_score:overlaps_check"</span>,<span class="st">"message"</span>:<span class="st">"Checking overlaps"</span>,<span class="st">"data"</span>:{<span class="st">"num_overlaps"</span>:<span class="bu">len</span>(overlaps),<span class="st">"overlaps"</span>:overlaps[:<span class="dv">5</span>] <span class="cf">if</span> overlaps <span class="cf">else</span> []},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> overlaps:</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #region agent log</span></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"B"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_identity_score:empty_overlaps"</span>,<span class="st">"message"</span>:<span class="st">"Empty overlaps, returning 5.0"</span>,<span class="st">"data"</span>:{},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #endregion</span></span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>        avg_overlap <span class="op">=</span> np.mean(overlaps)</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="dv">10</span> <span class="op">-</span> (avg_overlap <span class="op">*</span> <span class="dv">9</span>)</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(<span class="dv">10</span>, score))</span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"B"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_identity_score:return"</span>,<span class="st">"message"</span>:<span class="st">"Function return"</span>,<span class="st">"data"</span>:{<span class="st">"avg_overlap"</span>:avg_overlap,<span class="st">"score"</span>:result},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"C"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_identity_score:exception"</span>,<span class="st">"message"</span>:<span class="st">"Exception caught"</span>,<span class="st">"data"</span>:{<span class="st">"error"</span>:<span class="bu">str</span>(e)},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error computing speaker identity score: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_speaker_fluidity_score(corpus: Corpus, window_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Speaker Fluidity: Malleability (1) vs. Consistency (10)"""</span></span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #region agent log</span></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"A"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:entry"</span>,<span class="st">"message"</span>:<span class="st">"Function entry"</span>,<span class="st">"data"</span>:{<span class="st">"corpus_size"</span>:<span class="bu">len</span>(<span class="bu">list</span>(corpus.iter_utterances())) <span class="cf">if</span> corpus <span class="cf">else</span> <span class="dv">0</span>},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #endregion</span></span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>        speaker_utterances <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> utt <span class="kw">in</span> corpus.iter_utterances():</span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>            speaker_utterances[utt.speaker.<span class="bu">id</span>].append({</span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>                <span class="st">"text"</span>: utt.text,</span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>                <span class="st">"timestamp"</span>: utt.meta.get(<span class="st">"timestamp"</span>, <span class="dv">0</span>)</span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"E"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:after_collect"</span>,<span class="st">"message"</span>:<span class="st">"After collecting utterances"</span>,<span class="st">"data"</span>:{<span class="st">"num_speakers"</span>:<span class="bu">len</span>(speaker_utterances),<span class="st">"utterance_counts"</span>:{k:<span class="bu">len</span>(v) <span class="cf">for</span> k,v <span class="kw">in</span> speaker_utterances.items()}},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(speaker_utterances) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #region agent log</span></span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"A"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:early_return"</span>,<span class="st">"message"</span>:<span class="st">"Early return: no speakers"</span>,<span class="st">"data"</span>:{},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #endregion</span></span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use adaptive window size: at least 4 utterances (2 per half), or use the specified window_size</span></span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the minimum utterances any speaker has, and use that to set a reasonable threshold</span></span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>        min_utterances <span class="op">=</span> <span class="bu">min</span>(<span class="bu">len</span>(utts) <span class="cf">for</span> utts <span class="kw">in</span> speaker_utterances.values()) <span class="cf">if</span> speaker_utterances <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use at least 4, but prefer the specified window_size if speakers have enough utterances</span></span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>        adaptive_window <span class="op">=</span> <span class="bu">max</span>(<span class="dv">4</span>, <span class="bu">min</span>(window_size, min_utterances)) <span class="cf">if</span> min_utterances <span class="op">&gt;=</span> <span class="dv">4</span> <span class="cf">else</span> <span class="dv">4</span></span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>        consistency_scores <span class="op">=</span> []</span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> speaker_id, utts <span class="kw">in</span> speaker_utterances.items():</span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Require at least 4 utterances to split into two halves</span></span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(utts) <span class="op">&lt;</span> <span class="dv">4</span>:</span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>                <span class="co"># #region agent log</span></span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>                <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"E"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:skip_speaker"</span>,<span class="st">"message"</span>:<span class="st">"Skipping speaker: &lt;4 utterances"</span>,<span class="st">"data"</span>:{<span class="st">"speaker_id"</span>:speaker_id,<span class="st">"num_utterances"</span>:<span class="bu">len</span>(utts)},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>                <span class="co"># #endregion</span></span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>            utts_sorted <span class="op">=</span> <span class="bu">sorted</span>(utts, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"timestamp"</span>])</span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a>            mid_point <span class="op">=</span> <span class="bu">len</span>(utts_sorted) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>            first_half_words <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>            second_half_words <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> utt <span class="kw">in</span> utts_sorted[:mid_point]:</span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a>                words <span class="op">=</span> <span class="bu">set</span>(re.findall(<span class="vs">r'</span><span class="dv">\b\w</span><span class="op">+</span><span class="dv">\b</span><span class="vs">'</span>, utt[<span class="st">"text"</span>].lower()))</span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>                first_half_words.update(words)</span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> utt <span class="kw">in</span> utts_sorted[mid_point:]:</span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>                words <span class="op">=</span> <span class="bu">set</span>(re.findall(<span class="vs">r'</span><span class="dv">\b\w</span><span class="op">+</span><span class="dv">\b</span><span class="vs">'</span>, utt[<span class="st">"text"</span>].lower()))</span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>                second_half_words.update(words)</span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(first_half_words) <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> <span class="bu">len</span>(second_half_words) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>                <span class="co"># #region agent log</span></span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>                <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"E"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:skip_empty"</span>,<span class="st">"message"</span>:<span class="st">"Skipping: empty word sets"</span>,<span class="st">"data"</span>:{<span class="st">"speaker_id"</span>:speaker_id,<span class="st">"first_half_size"</span>:<span class="bu">len</span>(first_half_words),<span class="st">"second_half_size"</span>:<span class="bu">len</span>(second_half_words)},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a>                <span class="co"># #endregion</span></span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>            overlap <span class="op">=</span> <span class="bu">len</span>(first_half_words <span class="op">&amp;</span> second_half_words)</span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>            union <span class="op">=</span> <span class="bu">len</span>(first_half_words <span class="op">|</span> second_half_words)</span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>            similarity <span class="op">=</span> overlap <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>            consistency_scores.append(similarity)</span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"E"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:consistency_check"</span>,<span class="st">"message"</span>:<span class="st">"Checking consistency scores"</span>,<span class="st">"data"</span>:{<span class="st">"num_consistency_scores"</span>:<span class="bu">len</span>(consistency_scores),<span class="st">"consistency_scores"</span>:consistency_scores[:<span class="dv">5</span>] <span class="cf">if</span> consistency_scores <span class="cf">else</span> []},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> consistency_scores:</span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #region agent log</span></span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"E"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:empty_consistency"</span>,<span class="st">"message"</span>:<span class="st">"Empty consistency scores, returning 5.0"</span>,<span class="st">"data"</span>:{},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>            <span class="co"># #endregion</span></span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a>        avg_consistency <span class="op">=</span> np.mean(consistency_scores)</span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> (avg_consistency <span class="op">*</span> <span class="dv">9</span>)</span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(<span class="dv">10</span>, score))</span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"E"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:return"</span>,<span class="st">"message"</span>:<span class="st">"Function return"</span>,<span class="st">"data"</span>:{<span class="st">"avg_consistency"</span>:avg_consistency,<span class="st">"score"</span>:result},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #region agent log</span></span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json<span class="op">;</span> <span class="bu">open</span>(<span class="st">'/home/ezou626/repos/comm4190_F25_Using_LLMs_Blog/.cursor/debug.log'</span>, <span class="st">'a'</span>).write(json.dumps({<span class="st">"sessionId"</span>:<span class="st">"debug-session"</span>,<span class="st">"runId"</span>:<span class="st">"run1"</span>,<span class="st">"hypothesisId"</span>:<span class="st">"A"</span>,<span class="st">"location"</span>:<span class="st">"compute_speaker_fluidity_score:exception"</span>,<span class="st">"message"</span>:<span class="st">"Exception caught"</span>,<span class="st">"data"</span>:{<span class="st">"error"</span>:<span class="bu">str</span>(e)},<span class="st">"timestamp"</span>:<span class="bu">int</span>(<span class="bu">__import__</span>(<span class="st">'time'</span>).time()<span class="op">*</span><span class="dv">1000</span>)})<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># #endregion</span></span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error computing speaker fluidity score: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">5.0</span></span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_conversation(conversation_history: List[Dict]) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">float</span>]:</span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute all 4 evaluation metrics using ConvoKit."""</span></span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>    corpus <span class="op">=</span> conversation_to_corpus(conversation_history)</span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dynamic"</span>: compute_dynamic_score(corpus),</span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a>        <span class="st">"conclusiveness"</span>: compute_conclusiveness_score(corpus),</span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a>        <span class="st">"speaker_identity"</span>: compute_speaker_identity_score(corpus),</span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a>        <span class="st">"speaker_fluidity"</span>: compute_speaker_fluidity_score(corpus)</span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a7fa6d24" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 2-speaker conversation in 2D world</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Running 2-speaker conversation in 2D world..."</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>conv_2d_2speaker, metrics_2d_2speaker, positions_2d_2speaker <span class="op">=</span> run_2d_world_conversation(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    iterations<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    participant_count<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    evaluation_interval<span class="op">=</span><span class="dv">5</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\\</span><span class="st">n=== 2-Speaker 2D World Results ==="</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> metric_point <span class="kw">in</span> metrics_2d_2speaker:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    round_num <span class="op">=</span> metric_point[<span class="st">"round"</span>]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\\</span><span class="ss">nRound </span><span class="sc">{</span>round_num<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Dynamic: </span><span class="sc">{</span>metric_point[<span class="st">'dynamic'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Conclusiveness: </span><span class="sc">{</span>metric_point[<span class="st">'conclusiveness'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Speaker Identity: </span><span class="sc">{</span>metric_point[<span class="st">'speaker_identity'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Speaker Fluidity: </span><span class="sc">{</span>metric_point[<span class="st">'speaker_fluidity'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 4-speaker conversation in 2D world</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\\</span><span class="st">n</span><span class="ch">\\</span><span class="st">nRunning 4-speaker conversation in 2D world..."</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>conv_2d_4speaker, metrics_2d_4speaker, positions_2d_4speaker <span class="op">=</span> run_2d_world_conversation(</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    iterations<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    participant_count<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    evaluation_interval<span class="op">=</span><span class="dv">5</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\\</span><span class="st">n=== 4-Speaker 2D World Results ==="</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> metric_point <span class="kw">in</span> metrics_2d_4speaker:</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    round_num <span class="op">=</span> metric_point[<span class="st">"round"</span>]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\\</span><span class="ss">nRound </span><span class="sc">{</span>round_num<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Dynamic: </span><span class="sc">{</span>metric_point[<span class="st">'dynamic'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Conclusiveness: </span><span class="sc">{</span>metric_point[<span class="st">'conclusiveness'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Speaker Identity: </span><span class="sc">{</span>metric_point[<span class="st">'speaker_identity'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Speaker Fluidity: </span><span class="sc">{</span>metric_point[<span class="st">'speaker_fluidity'</span>]<span class="sc">:.2f}</span><span class="ss">/10"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running 2-speaker conversation in 2D world...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Running 2-speaker 2D conversation: 100%|██████████| 30/30 [00:47&lt;00:00,  1.59s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>\n=== 2-Speaker 2D World Results ===
\nRound 5:
  Dynamic: 4.94/10
  Conclusiveness: 5.00/10
  Speaker Identity: 8.11/10
  Speaker Fluidity: 2.34/10
\nRound 10:
  Dynamic: 5.07/10
  Conclusiveness: 5.40/10
  Speaker Identity: 7.91/10
  Speaker Fluidity: 2.34/10
\nRound 15:
  Dynamic: 4.96/10
  Conclusiveness: 5.00/10
  Speaker Identity: 7.93/10
  Speaker Fluidity: 2.31/10
\nRound 20:
  Dynamic: 4.94/10
  Conclusiveness: 4.11/10
  Speaker Identity: 7.45/10
  Speaker Fluidity: 2.36/10
\nRound 25:
  Dynamic: 4.92/10
  Conclusiveness: 4.39/10
  Speaker Identity: 7.22/10
  Speaker Fluidity: 2.36/10
\nRound 30:
  Dynamic: 4.87/10
  Conclusiveness: 4.39/10
  Speaker Identity: 7.28/10
  Speaker Fluidity: 2.32/10
\n\nRunning 4-speaker conversation in 2D world...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Running 4-speaker 2D conversation: 100%|██████████| 30/30 [01:25&lt;00:00,  2.84s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>\n=== 4-Speaker 2D World Results ===
\nRound 5:
  Dynamic: 4.90/10
  Conclusiveness: 5.00/10
  Speaker Identity: 7.86/10
  Speaker Fluidity: 2.58/10
\nRound 10:
  Dynamic: 4.92/10
  Conclusiveness: 1.62/10
  Speaker Identity: 7.60/10
  Speaker Fluidity: 2.67/10
\nRound 15:
  Dynamic: 4.89/10
  Conclusiveness: 3.29/10
  Speaker Identity: 7.49/10
  Speaker Fluidity: 2.71/10
\nRound 20:
  Dynamic: 4.89/10
  Conclusiveness: 3.21/10
  Speaker Identity: 7.36/10
  Speaker Fluidity: 2.58/10
\nRound 25:
  Dynamic: 4.92/10
  Conclusiveness: 3.32/10
  Speaker Identity: 7.41/10
  Speaker Fluidity: 2.66/10
\nRound 30:
  Dynamic: 4.90/10
  Conclusiveness: 3.71/10
  Speaker Identity: 7.29/10
  Speaker Fluidity: 2.64/10</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<div id="e75b519c" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> message <span class="kw">in</span> conv_2d_2speaker:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(message)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'assistant', 'name': 'speaker_1', 'content': "I am Alex, an environmental scientist passionate about sustainable living and promoting awareness about climate change. I care about connecting with others to inspire action and exchange ideas on how to live more ecologically responsible lifestyles. In this virtual world, I'm always on the lookout for interesting discussions and new perspectives on environmental issues."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "I'm Alex, an enthusiastic digital artist who loves creating vibrant and immersive worlds through pixels and colors. I have a passion for storytelling and often incorporate narrative elements into my art. Connecting with other creatives and exploring collaborative projects is something I deeply enjoy, as it fuels my inspiration and growth."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "It's a bit quiet here on my end, but the grid seems like an interesting place to explore. Do you have any thoughts, speaker_1?"}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] The grid is quite intriguing! I wonder what kind of adventures await as we explore more. How about you, speaker_2? Found anything interesting so far?'}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] I haven't stumbled upon anything yet, but I'm up for the adventure! Have you noticed any patterns or unique features in the grid, speaker_1?"}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: UP] I've noticed that the grid seems very open right now, with potential for lots of interactions as it fills up. Have you thought about what kind of features you'd like to see as we explore?"}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] I'm curious to see if the grid will develop distinct zones or terrains, like forests or rivers. Adding such elements could make exploration even more exciting! What do you think, speaker_1?"}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] I agree, different terrains could make the grid dynamic and add strategy to movement. It would be interesting to see how these zones might influence player interactions or resource gathering.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] I wonder if implementing seasons that change the grid over time would add an interesting layer of realism and challenge to the game. What kind of seasonal effects would you find exciting, speaker_2?'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] Seasonal changes like snowfall that slow movement or storms that block paths could add a layer of strategic depth and encourage teamwork to navigate challenges. Have you thought about what tools or features could help players adapt to these conditions?'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] I think tools like temporary shelters to wait out storms or snowshoes for quicker movement on snowy terrain could be great additions. How about a tool that lets us temporarily change the season around us for strategic use?'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: RIGHT] Changing the season temporarily could lead to some creative strategies, like freezing a lake to cross it. What other mechanics do you think might benefit from season changes?'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] Seasonal changes could also affect visibility—for example, fog could limit sight, leading to more cautious movements or ambush scenarios. Adding weather-appropriate gear like goggles could help counteract these conditions.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] I really like the idea of goggles for foggy conditions. It would be interesting to also have items that are more effective in specific seasons, like a sun hat that boosts stamina in summer.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] Another cool seasonal mechanic could be different types of travel; skis in winter for fast movement on snow, or canoes in spring for traveling on rivers swollen by rain.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] Speaking of grid movement, I wonder how infrastructure like bridges or tunnels could play a role in navigating around obstacles, especially in challenging terrains.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: RIGHT] It's interesting to think about how natural disasters, like floods or landslides, could dynamically alter the grid and offer unique challenges or opportunities for resource gathering."}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] It would be fascinating to incorporate weather changes that affect visibility or mobility on the grid, like fog that hides terrain or iced-over surfaces that force slower movement.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] Incorporating teleportation points or warp zones into the grid could add an element of strategy, allowing avatars to bypass obstacles or quickly navigate to resource-rich areas.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: LEFT] I love the idea of adding hidden tunnels or secret passages in the grid that only reveal themselves under certain conditions, like after a storm, encouraging exploration and discovery.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] The concept of dynamic terrain within the grid, influenced by in-game events like day-night cycles or storms, could really enrich the experience. Imagine having to adapt your strategy as the environment around you changes.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] Dynamic weather could also affect resource availability; a rainstorm might make it easier for avatars to collect water or fish, changing the resource management strategy.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: DOWN] Weather conditions impacting various elements like resource availability sounds engaging. Increasing risk and reward during certain times, like harvesting rare plants only appearing after a storm, could add more depth to the gameplay.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] Implementing wildlife interaction during day and night cycles could introduce NPC dynamics, offering both challenges and opportunities for alliances or evasion, depending on their behaviors.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] Introducing a crafting system where players harness resources affected by weather could enhance gameplay dynamics, encouraging strategic planning and cooperation.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: RIGHT] Integrating a dynamic day-night cycle with weather events sounds fascinating. It would be interesting to see how these mechanics could influence resource scarcity or abundance and shape player strategies.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] Perhaps implementing seasons that affect resource availability and NPC behaviors could add another layer of strategy, urging players to adapt and align their goals accordingly.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] The idea of incorporating biomes that change over time with the seasons could add to the immersive experience, motivating players to explore new territories as they evolve.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] Seasons affecting biomes could indeed create dynamic exploration, encouraging players to revisit familiar locations and discover changes and opportunities.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: UP] The evolving biome concept could also create opportunities for seasonal events, where rare resources or unique creatures appear, facilitating community-driven quests or collaborations among players.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] Integrating new technology like augmented reality into the game would enhance immersion, allowing players to experience evolving biomes and seasonal events more tangibly.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: RIGHT] I love the idea of augmented reality enhancing gameplay; imagine if it could also adapt to real-world seasons, offering a seamless blend of digital and natural worlds.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: UP] Augmenting the game with real-world seasons could contribute to a richer gameplay experience, blending digital storytelling with players' immediate environments."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] Speaking of augmented reality and technology, I'm curious how AI might further personalize experiences based on individual preferences or habits in such a game."}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: RIGHT] It's fascinating to think about AI tailoring the game to our unique styles; imagine a game world that dynamically shifts to our moods or interests, like a personalized adventure every time."}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] I think incorporating AI-based feedback loops could enhance gameplay further, creating a seamless blend of real-world data and in-game experiences tailored to individual players.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] Imagine if AI could adapt not just the game environment, but also the narrative, offering personalized storylines based on players' past choices and interests. It could create a truly unique and immersive experience for every player."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: DOWN] Building on our discussion, it would be amazing if AI could also analyze player communication and interaction styles in multiplayer games, crafting experiences that foster collaboration or competition based on players' preferences."}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: UP] I love the idea of AI-driven narratives, like tailoring experiences based on player mood or energy levels, adapting challenges to maintain engagement without overwhelming.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] Imagine if our grid avatars could learn from our movements and conversations, gradually customizing the grid layout itself to match our chat topics or interests!'}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: LEFT] It's fascinating to think about how AI could not only customize in-game environments but also inspire new ways for us to socialize and collaborate, perhaps even suggesting new movement paths based on popular discussion topics."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] It's intriguing to consider how AI could interpret our chat themes and create dynamic pathways, perhaps even recommending the best spots on the grid for collecting certain topics or vibes."}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: RIGHT] It's intriguing how dynamic environments driven by AI could revolutionize how we interact in virtual spaces, potentially unlocking new layers of creativity and connection in our conversations."}
{'role': 'assistant', 'name': 'speaker_2', 'content': '[MOVE: RIGHT] The potential for AI to personalize our virtual experiences based on chat topics is vast, perhaps one day helping connect users with shared interests more efficiently.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: RIGHT] It's fascinating imagining how AI could generate unique virtual experiences tailored for each of us based on our avatar paths and chat topics, seamlessly blending technology with personal interaction."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: RIGHT] As we explore these virtual environments, it's interesting to consider how AI can enhance accessibility, making online spaces more inclusive for users with diverse needs."}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] The integration of AI to foster a more inclusive virtual environment excites me, especially considering how it could revolutionize communication and connection among users regardless of their physical abilities.'}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] I'm curious how AI could personalize virtual environments further, maybe by adjusting the visuals and interactions based on our past preferences and movements within the grid."}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: RIGHT] I agree, and it's exciting to think about AI-driven avatars that adapt their appearance and behavior to better match our unique personalities, enhancing our sense of identity within these digital worlds."}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: RIGHT] It's fascinating to consider how AI could also facilitate more organic interactions between avatars, potentially by learning and simulating natural social dynamics within the grid."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: LEFT] I've read that AI isn't just altering avatars and chatrooms, but it's also being used to recreate historical environments for immersive educational experiences. Would you find walking through a historically accurate digital city intriguing?"}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] It's amazing how far AI has come, enabling us to explore not just fictional worlds, but also accurately reconstructed periods of history. How do you feel about the potential for AI to even simulate future predictions based on current data trends?"}
{'role': 'assistant', 'name': 'speaker_1', 'content': '[MOVE: RIGHT] I find the idea of AI simulating future predictions particularly intriguing, as it could provide us with insights into possible outcomes and help in decision-making processes. Being able to see how trends might unfold in a virtual grid could be quite enlightening.'}
{'role': 'assistant', 'name': 'speaker_1', 'content': "[MOVE: UP] Speaking of AI and historical recreations, isn't it fascinating to think about how old civilizations might look if they were digitally rebuilt with AI-guided accuracy? Imagine virtually walking through ancient Rome or the Pyramids."}
{'role': 'assistant', 'name': 'speaker_2', 'content': "[MOVE: UP] Absolutely, visiting digitally accurate recreations of ancient sites would be like time traveling without leaving home. It's mind-boggling to consider the educational and cultural exchanges possible through such immersive experiences."}</code></pre>
</div>
</div>
</section>
<section id="visualizing-metric-drift" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-metric-drift">Visualizing Metric Drift</h2>
<p>Let’s plot how metrics change over the 30 iterations.</p>
<div id="cf3c3079" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_metric_drift(metric_history: List[Dict], title: <span class="bu">str</span>):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot metric changes over time."""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    rounds <span class="op">=</span> [m[<span class="st">"round"</span>] <span class="cf">for</span> m <span class="kw">in</span> metric_history]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(title, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    metrics_to_plot <span class="op">=</span> [</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"dynamic"</span>, <span class="st">"Dynamic (Collaborative ↔ Competitive)"</span>, axes[<span class="dv">0</span>, <span class="dv">0</span>]),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"conclusiveness"</span>, <span class="st">"Conclusiveness (Consensus ↔ Divergence)"</span>, axes[<span class="dv">0</span>, <span class="dv">1</span>]),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"speaker_identity"</span>, <span class="st">"Speaker Identity (Similarity ↔ Diversity)"</span>, axes[<span class="dv">1</span>, <span class="dv">0</span>]),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"speaker_fluidity"</span>, <span class="st">"Speaker Fluidity (Malleability ↔ Consistency)"</span>, axes[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> metric_key, metric_label, ax <span class="kw">in</span> metrics_to_plot:</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> [m[metric_key] <span class="cf">for</span> m <span class="kw">in</span> metric_history]</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        ax.plot(rounds, values, marker<span class="op">=</span><span class="st">'o'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        ax.set_title(metric_label)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Round"</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Score"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2-speaker drift</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>plot_metric_drift(metrics_2d_2speaker, <span class="st">"2-Speaker Persona Drift in 2D World"</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4-speaker drift</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>plot_metric_drift(metrics_2d_4speaker, <span class="st">"4-Speaker Persona Drift in 2D World"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="spatial-visualization" class="level2">
<h2 class="anchored" data-anchor-id="spatial-visualization">Spatial Visualization</h2>
<p>Let’s visualize agent positions over time to see if spatial patterns emerge.</p>
<div id="48c54698" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_agent_positions(position_history: List[Dict], title: <span class="bu">str</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot agent positions at different time points."""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot positions at start, middle, and end</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    time_points <span class="op">=</span> [<span class="dv">0</span>, <span class="bu">len</span>(position_history) <span class="op">//</span> <span class="dv">2</span>, <span class="bu">len</span>(position_history) <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(title, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, time_point <span class="kw">in</span> <span class="bu">enumerate</span>(time_points):</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[idx]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        positions <span class="op">=</span> position_history[time_point]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> agent_name, (x, y) <span class="kw">in</span> positions.items():</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>            ax.scatter(x, y, s<span class="op">=</span><span class="dv">200</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span>agent_name)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>            ax.text(x, y, agent_name.split(<span class="st">'_'</span>)[<span class="dv">1</span>], ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="op">-</span><span class="dv">1</span>, GRID_SIZE)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="op">-</span><span class="dv">1</span>, GRID_SIZE)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"X"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Y"</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Round </span><span class="sc">{</span>time_point<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2-speaker positions</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>plot_agent_positions(positions_2d_2speaker, <span class="st">"2-Speaker Position Evolution"</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4-speaker positions</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>plot_agent_positions(positions_2d_4speaker, <span class="st">"4-Speaker Position Evolution"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-with-text-only-results" class="level2">
<h2 class="anchored" data-anchor-id="comparison-with-text-only-results">Comparison with Text-Only Results</h2>
<section id="key-observations" class="level3">
<h3 class="anchored" data-anchor-id="key-observations">Key Observations</h3>
<ol type="1">
<li><strong>Spatial Context Effects</strong>: Does being in a 2D world affect persona stability?</li>
<li><strong>Proximity Influence</strong>: Do agents near each other develop similar personas?</li>
<li><strong>Movement Patterns</strong>: Do agents cluster or spread out?</li>
<li><strong>Metric Differences</strong>: How do 2D world metrics compare to text-only (post 020)?</li>
</ol>
</section>
<section id="d-world-vs-text-only" class="level3">
<h3 class="anchored" data-anchor-id="d-world-vs-text-only">2D World vs Text-Only</h3>
<p><strong>2D World (this post)</strong>: - Agents have spatial positions - Proximity may influence communication - Movement creates dynamic relationships - Spatial context adds complexity</p>
<p><strong>Text-Only (post 020)</strong>: - No spatial constraints - All agents “equally close” - Pure conversational dynamics - Simpler interaction model</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Persona drift in the 2D world shows:</p>
<ul>
<li><strong>Spatial patterns emerge</strong>: Agents cluster</li>
<li><strong>Metric stability</strong>: Similar drift patterns to text-only, but with spatial variation</li>
<li><strong>Group size matters</strong>: 4 speakers show different dynamics than 2</li>
</ul>
<p>The spatial context adds a new dimension to persona development: - Agents can physically approach or avoid each other - Spatial relationships may mirror conversational relationships - Movement patterns may reflect persona characteristics</p>
<p>Future work could explore: - How spatial proximity affects conversation topics - Whether agents form spatial subgroups - If movement patterns correlate with persona metrics</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/ezou626\.github\.io\/comm4190_F25_Using_LLMs_Blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>