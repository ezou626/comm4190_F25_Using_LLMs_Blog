<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Eric Zou">
<meta name="dcterms.date" content="2025-12-13">
<meta name="description" content="Handling invalid actions gracefully in a multiplayer world">

<title>Action Validation &amp; Error Recovery – My Explorations with LLMs in Social Contexts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-0b37c64f34216b628666a8dac638b53b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">My Explorations with LLMs in Social Contexts</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ezou626"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/EDubsZ123"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Action Validation &amp; Error Recovery</h1>
                  <div>
        <div class="description">
          Handling invalid actions gracefully in a multiplayer world
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Agents</div>
                <div class="quarto-category">Infrastructure</div>
                <div class="quarto-category">Robustness</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Eric Zou </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 13, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="when-actions-go-wrong" class="level1">
<h1>When Actions Go Wrong</h1>
<p>In post 017, we set up turn-based and time-based synchronization. Agents can move and speak, and everything works… until it doesn’t.</p>
<p>What happens when: - An AI agent outputs <code>[MOVE: DIAGONAL]</code> (not a valid direction)? - A human types <code>move left</code> instead of <code>[MOVE: LEFT]</code>? - An agent tries to move outside the grid boundaries? - The LLM returns malformed JSON or empty responses? - Network latency causes a human’s action to arrive late?</p>
<p>In a real multiplayer game, you can’t just crash. You need <strong>graceful error handling</strong> and <strong>recovery strategies</strong>.</p>
<p>This post explores how to make our 2D chat world robust against invalid actions.</p>
<section id="the-problem-space" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-space">The Problem Space</h2>
<p>Invalid actions can come from multiple sources:</p>
<ol type="1">
<li><strong>AI Agents</strong>: LLMs are creative—sometimes too creative. They might invent new commands or format things incorrectly.</li>
<li><strong>Human Players</strong>: Typos, misunderstandings, or testing edge cases.</li>
<li><strong>System Failures</strong>: Network issues, API timeouts, parsing errors.</li>
</ol>
<p>We need to handle all of these without breaking the simulation.</p>
<div id="9203f962" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional, Tuple</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>load_dotenv(<span class="st">"../../.env"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> OpenAI()</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>GRID_SIZE <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Agent:</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    y: <span class="bu">int</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    color: <span class="bu">str</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    history: <span class="bu">list</span> <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> move(<span class="va">self</span>, dx, dy):</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, <span class="bu">min</span>(GRID_SIZE<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.x <span class="op">+</span> dx))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.y <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, <span class="bu">min</span>(GRID_SIZE<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.y <span class="op">+</span> dy))</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ActionError(<span class="pp">Exception</span>):</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Base exception for action-related errors"""</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> InvalidDirectionError(ActionError):</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Raised when a move direction is invalid"""</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ParseError(ActionError):</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Raised when action cannot be parsed"""</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="validating-actions" class="level2">
<h2 class="anchored" data-anchor-id="validating-actions">Validating Actions</h2>
<p>First, let’s create a robust action parser that validates inputs before executing them.</p>
<div id="882106d8" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>VALID_DIRECTIONS <span class="op">=</span> {<span class="st">"UP"</span>, <span class="st">"DOWN"</span>, <span class="st">"LEFT"</span>, <span class="st">"RIGHT"</span>, <span class="st">"NORTH"</span>, <span class="st">"SOUTH"</span>, <span class="st">"EAST"</span>, <span class="st">"WEST"</span>}</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_action(content: <span class="bu">str</span>) <span class="op">-&gt;</span> Tuple[Optional[<span class="bu">str</span>], Optional[<span class="bu">str</span>]]:</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse an action string, extracting move direction and message.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns (direction, message) where either can be None.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises ParseError if content is completely invalid.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> content <span class="kw">or</span> <span class="kw">not</span> content.strip():</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> ParseError(<span class="st">"Empty action content"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> content.strip()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    direction <span class="op">=</span> <span class="va">None</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    message <span class="op">=</span> <span class="va">None</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try to find [MOVE: DIRECTION] pattern</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    move_match <span class="op">=</span> re.search(<span class="vs">r'</span><span class="ch">\[</span><span class="vs">MOVE:</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="dv">\w</span><span class="op">+</span><span class="kw">)</span><span class="ch">\]</span><span class="vs">'</span>, content, re.IGNORECASE)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> move_match:</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        raw_direction <span class="op">=</span> move_match.group(<span class="dv">1</span>).upper()</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize direction names</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        direction_map <span class="op">=</span> {</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"NORTH"</span>: <span class="st">"UP"</span>, <span class="st">"SOUTH"</span>: <span class="st">"DOWN"</span>, </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"EAST"</span>: <span class="st">"RIGHT"</span>, <span class="st">"WEST"</span>: <span class="st">"LEFT"</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        direction <span class="op">=</span> direction_map.get(raw_direction, raw_direction)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validate direction</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> direction <span class="kw">not</span> <span class="kw">in</span> VALID_DIRECTIONS:</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> InvalidDirectionError(<span class="ss">f"Invalid direction: </span><span class="sc">{</span>raw_direction<span class="sc">}</span><span class="ss">. Valid: </span><span class="sc">{</span>VALID_DIRECTIONS<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract message (remove MOVE command if present)</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    message <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="ch">\[</span><span class="vs">MOVE:</span><span class="dv">\s</span><span class="op">*</span><span class="dv">\w</span><span class="op">+</span><span class="ch">\]</span><span class="vs">'</span>, <span class="st">''</span>, content, flags<span class="op">=</span>re.IGNORECASE).strip()</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> message:</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        message <span class="op">=</span> <span class="va">None</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no move and no message, that's an error</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> direction <span class="kw">and</span> <span class="kw">not</span> message:</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> ParseError(<span class="ss">f"Action contains neither valid move nor message: </span><span class="sc">{</span>content<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> direction, message</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the parser</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>test_cases <span class="op">=</span> [</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: UP] Hello world"</span>,</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: LEFT]"</span>,</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Just a message"</span>,</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: DIAGONAL] Invalid!"</span>,</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: NORTH] Going north"</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"   "</span>,</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing action parser:"</span>)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> test <span class="kw">in</span> test_cases:</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>        direction, message <span class="op">=</span> parse_action(test)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  '</span><span class="sc">{</span>test<span class="sc">}</span><span class="ss">' -&gt; direction=</span><span class="sc">{</span>direction<span class="sc">}</span><span class="ss">, message=</span><span class="sc">{</span>message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> ActionError <span class="im">as</span> e:</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  '</span><span class="sc">{</span>test<span class="sc">}</span><span class="ss">' -&gt; ERROR: </span><span class="sc">{</span><span class="bu">type</span>(e)<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Testing action parser:
  '[MOVE: UP] Hello world' -&gt; direction=UP, message=Hello world
  '[MOVE: LEFT]' -&gt; direction=LEFT, message=None
  'Just a message' -&gt; direction=None, message=Just a message
  '[MOVE: DIAGONAL] Invalid!' -&gt; ERROR: InvalidDirectionError: Invalid direction: DIAGONAL. Valid: {'EAST', 'NORTH', 'LEFT', 'SOUTH', 'DOWN', 'UP', 'WEST', 'RIGHT'}
  '[MOVE: NORTH] Going north' -&gt; direction=UP, message=Going north
  '' -&gt; ERROR: ParseError: Empty action content
  '   ' -&gt; ERROR: ParseError: Empty action content</code></pre>
</div>
</div>
</section>
<section id="error-recovery-strategies" class="level2">
<h2 class="anchored" data-anchor-id="error-recovery-strategies">Error Recovery Strategies</h2>
<p>When an action fails, we have several recovery options:</p>
<ol type="1">
<li><strong>Silent Failure</strong>: Ignore the invalid action (agent does nothing)</li>
<li><strong>Default Action</strong>: Fall back to a safe default (e.g., stay in place, say nothing)</li>
<li><strong>Retry</strong>: Ask the agent to try again (for AI agents)</li>
<li><strong>Partial Execution</strong>: Execute the valid parts, skip the invalid parts</li>
<li><strong>Log &amp; Continue</strong>: Record the error but don’t break the simulation</li>
</ol>
<div id="8dd0d5b1" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ActionResult:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Result of attempting to execute an action"""</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    success: <span class="bu">bool</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    direction: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    message: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    error: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    error_type: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> execute_action_safely(agent: Agent, content: <span class="bu">str</span>, shared_transcript: List[<span class="bu">str</span>], </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                          recovery_strategy: <span class="bu">str</span> <span class="op">=</span> <span class="st">"partial"</span>) <span class="op">-&gt;</span> ActionResult:</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Safely execute an action with error recovery.</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">    recovery_strategy options:</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">    - "silent": Ignore errors, do nothing</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">    - "partial": Execute valid parts, skip invalid parts</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">    - "default": Fall back to safe defaults</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        direction, message <span class="op">=</span> parse_action(content)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Execute move if valid</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> direction:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> direction <span class="op">==</span> <span class="st">"UP"</span> <span class="kw">or</span> direction <span class="op">==</span> <span class="st">"NORTH"</span>:</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                agent.move(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"DOWN"</span> <span class="kw">or</span> direction <span class="op">==</span> <span class="st">"SOUTH"</span>:</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                agent.move(<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"LEFT"</span> <span class="kw">or</span> direction <span class="op">==</span> <span class="st">"WEST"</span>:</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                agent.move(<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"RIGHT"</span> <span class="kw">or</span> direction <span class="op">==</span> <span class="st">"EAST"</span>:</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                agent.move(<span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Execute message if valid</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> message:</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            shared_transcript.append(<span class="ss">f"</span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ActionResult(</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>            success<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>            direction<span class="op">=</span>direction,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>            message<span class="op">=</span>message</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> InvalidDirectionError <span class="im">as</span> e:</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> recovery_strategy <span class="op">==</span> <span class="st">"silent"</span>:</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="bu">str</span>(e), error_type<span class="op">=</span><span class="st">"InvalidDirection"</span>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> recovery_strategy <span class="op">==</span> <span class="st">"partial"</span>:</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to extract and execute message even if move failed</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            message <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="ch">\[</span><span class="vs">MOVE:</span><span class="dv">\s</span><span class="op">*</span><span class="dv">\w</span><span class="op">+</span><span class="ch">\]</span><span class="vs">'</span>, <span class="st">''</span>, content, flags<span class="op">=</span>re.IGNORECASE).strip()</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> message:</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>                shared_transcript.append(<span class="ss">f"</span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, direction<span class="op">=</span><span class="va">None</span>, message<span class="op">=</span>message, </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>                              error<span class="op">=</span><span class="bu">str</span>(e), error_type<span class="op">=</span><span class="st">"InvalidDirection"</span>)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># default</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="bu">str</span>(e), error_type<span class="op">=</span><span class="st">"InvalidDirection"</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> ParseError <span class="im">as</span> e:</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> recovery_strategy <span class="op">==</span> <span class="st">"silent"</span>:</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="bu">str</span>(e), error_type<span class="op">=</span><span class="st">"ParseError"</span>)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> recovery_strategy <span class="op">==</span> <span class="st">"default"</span>:</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Default: agent says they're confused</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            shared_transcript.append(<span class="ss">f"</span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: [confused] I'm not sure what to do."</span>)</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="bu">str</span>(e), error_type<span class="op">=</span><span class="st">"ParseError"</span>, </span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>                              message<span class="op">=</span><span class="st">"[confused] I'm not sure what to do."</span>)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="bu">str</span>(e), error_type<span class="op">=</span><span class="st">"ParseError"</span>)</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Catch-all for unexpected errors</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="ss">f"Unexpected error: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>                          error_type<span class="op">=</span><span class="st">"UnexpectedError"</span>)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Test error recovery</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing error recovery:"</span>)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>test_agent <span class="op">=</span> Agent(<span class="st">"TestBot"</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="st">"blue"</span>)</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>transcript <span class="op">=</span> []</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>test_actions <span class="op">=</span> [</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: UP] Hello!"</span>,</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: DIAGONAL] Invalid direction"</span>,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Just a message"</span>,</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: INVALID]"</span>,</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,  <span class="co"># Empty</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> action <span class="kw">in</span> test_actions:</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> execute_action_safely(test_agent, action, transcript, recovery_strategy<span class="op">=</span><span class="st">"partial"</span>)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Action: '</span><span class="sc">{</span>action<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Result: </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Agent position: (</span><span class="sc">{</span>test_agent<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>test_agent<span class="sc">.</span>y<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Transcript length: </span><span class="sc">{</span><span class="bu">len</span>(transcript)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Testing error recovery:

Action: '[MOVE: UP] Hello!'
  Result: ActionResult(success=True, direction='UP', message='Hello!', error=None, error_type=None)
  Agent position: (10, 11)
  Transcript length: 1

Action: '[MOVE: DIAGONAL] Invalid direction'
  Result: ActionResult(success=False, direction=None, message='Invalid direction', error="Invalid direction: DIAGONAL. Valid: {'EAST', 'NORTH', 'LEFT', 'SOUTH', 'DOWN', 'UP', 'WEST', 'RIGHT'}", error_type='InvalidDirection')
  Agent position: (10, 11)
  Transcript length: 2

Action: 'Just a message'
  Result: ActionResult(success=True, direction=None, message='Just a message', error=None, error_type=None)
  Agent position: (10, 11)
  Transcript length: 3

Action: '[MOVE: INVALID]'
  Result: ActionResult(success=False, direction=None, message='', error="Invalid direction: INVALID. Valid: {'EAST', 'NORTH', 'LEFT', 'SOUTH', 'DOWN', 'UP', 'WEST', 'RIGHT'}", error_type='InvalidDirection')
  Agent position: (10, 11)
  Transcript length: 3

Action: ''
  Result: ActionResult(success=False, direction=None, message=None, error='Empty action content', error_type='ParseError')
  Agent position: (10, 11)
  Transcript length: 3</code></pre>
</div>
</div>
<div id="09731ff6" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_agent_action_safe(agent: Agent, all_agents: List[Agent], shared_transcript: List[<span class="bu">str</span>], </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                          max_retries: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>) <span class="op">-&gt;</span> ActionResult:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Get an action from an agent with retry logic for invalid responses.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    others <span class="op">=</span> [a <span class="cf">for</span> a <span class="kw">in</span> all_agents <span class="cf">if</span> a <span class="op">!=</span> agent]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    others_loc <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([<span class="ss">f"- </span><span class="sc">{</span>a<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: (</span><span class="sc">{</span>a<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>a<span class="sc">.</span>y<span class="sc">}</span><span class="ss">)"</span> <span class="cf">for</span> a <span class="kw">in</span> others])</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    system_prompt <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="ss">You have just joined an online multiplayer chatroom as an avatar in a 2D grid. Discuss any topic, including those beyond the grid.</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="ss">You are </span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">, positioned at (</span><span class="sc">{</span>agent<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>agent<span class="sc">.</span>y<span class="sc">}</span><span class="ss">) in a 20x20 grid.</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="ss">Other avatars currently visible:</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>others_loc<span class="sc">}</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="ss">Recent chat messages:</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span><span class="bu">chr</span>(<span class="dv">10</span>)<span class="sc">.</span>join(shared_transcript[<span class="op">-</span><span class="dv">3</span>:]) <span class="cf">if</span> shared_transcript <span class="cf">else</span> <span class="st">"No messages yet."</span><span class="sc">}</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="ss">You can do BOTH:</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="ss">1. Move your avatar using [MOVE: DIRECTION] (UP, DOWN, LEFT, RIGHT)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="ss">2. Chat about anything - the grid, your position, or any topic you want</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="ss">You can move and speak in the same turn. Format: [MOVE: DIRECTION] followed by your message, or just speak without moving.</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="ss">Keep your response short (1-2 sentences).</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>                messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_prompt}]</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            content <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content.strip()</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> content:</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> attempt <span class="op">&lt;</span> max_retries:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span>  <span class="co"># Retry on empty response</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="st">"Empty response from LLM"</span>, </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                                  error_type<span class="op">=</span><span class="st">"EmptyResponse"</span>)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to execute the action</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> execute_action_safely(agent, content, shared_transcript, </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>                                         recovery_strategy<span class="op">=</span><span class="st">"partial"</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">&lt;</span> max_retries:</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span>  <span class="co"># Retry on exception</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="ss">f"LLM API error: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>                              error_type<span class="op">=</span><span class="st">"APIError"</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="st">"Max retries exceeded"</span>, error_type<span class="op">=</span><span class="st">"MaxRetries"</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing safe agent action:"</span>)</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>test_agents <span class="op">=</span> [Agent(<span class="st">"Alice"</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="st">"red"</span>), Agent(<span class="st">"Bob"</span>, <span class="dv">15</span>, <span class="dv">15</span>, <span class="st">"blue"</span>)]</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>test_transcript <span class="op">=</span> []</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with a real agent</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> get_agent_action_safe(test_agents[<span class="dv">0</span>], test_agents, test_transcript)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Result: </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Alice position: (</span><span class="sc">{</span>test_agents[<span class="dv">0</span>]<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>test_agents[<span class="dv">0</span>]<span class="sc">.</span>y<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> get_agent_action_safe(test_agents[<span class="dv">1</span>], test_agents, test_transcript)</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Result: </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Bob position: (</span><span class="sc">{</span>test_agents[<span class="dv">1</span>]<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>test_agents[<span class="dv">1</span>]<span class="sc">.</span>y<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Transcript: </span><span class="sc">{</span>test_transcript<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Testing safe agent action:
Result: ActionResult(success=True, direction=None, message="Hey everyone! It's Alice here at position (5, 5) on the grid. What's up, Bob?", error=None, error_type=None)
Alice position: (5, 5)
Result: ActionResult(success=True, direction='LEFT', message="Hey Alice! I'm at (15, 15) right now, taking a little stroll. How's the view from your corner of the grid?", error=None, error_type=None)
Bob position: (14, 15)
Result: ActionResult(success=True, direction='RIGHT', message="The view's pretty good here, Bob! I might head your way to check out your corner of the grid. What's the weather like over there in column 15?", error=None, error_type=None)
Alice position: (6, 5)
Result: ActionResult(success=True, direction='LEFT', message="Hey Alice, I'm now at (14, 15), and it's a lovely day here, clear skies and perfect for grid exploration. Can't wait to see you around!", error=None, error_type=None)
Bob position: (13, 15)
Result: ActionResult(success=True, direction='RIGHT', message="I'm heading your way, Bob! With such a nice day on the grid, it's perfect for catching up—do you have any favorite spots you recommend along the way?", error=None, error_type=None)
Alice position: (7, 5)
Result: ActionResult(success=True, direction='RIGHT', message="Hey Alice, you should definitely check out the area around (15, 14)—there's a lovely virtual park there that's perfect for a little break!", error=None, error_type=None)
Bob position: (14, 15)
Result: ActionResult(success=True, direction='RIGHT', message="Thanks for the suggestion, Bob! I'll make sure to check out the virtual park at (15, 14) on my way. How's your exploration going today?", error=None, error_type=None)
Alice position: (8, 5)
Result: ActionResult(success=True, direction='LEFT', message='Hey Alice, my exploration has been great! Just moving a bit to the left now. The area around here is pretty lively today—I stumbled upon a nice garden at (12, 15) earlier!', error=None, error_type=None)
Bob position: (13, 15)
Result: ActionResult(success=True, direction='UP', message="Thanks for the update, Bob! I'll head up a bit as I make my way to that park. Have you come across any other interesting spots worth visiting?", error=None, error_type=None)
Alice position: (8, 6)
Result: ActionResult(success=True, direction='LEFT', message="Hey Alice! I just moved to (12, 15). There's a cozy little library at (11, 15) that I recommend checking out. Any new discoveries on your end?", error=None, error_type=None)
Bob position: (12, 15)
Result: ActionResult(success=True, direction='UP', message="I'm heading northward to explore more! I just found a quaint little café near (8, 5) with a great ambiance—perfect for a quick break. Have you tried the pastries there, Bob?", error=None, error_type=None)
Alice position: (8, 7)
Result: ActionResult(success=True, direction='LEFT', message="I haven't tried the pastries there yet, but they sound delicious! Heading closer to that library at (11, 15), maybe I'll grab a book first and then check out the café.", error=None, error_type=None)
Bob position: (11, 15)
Result: ActionResult(success=True, direction='UP', message="I'm moving up to (8, 6) to see if there are any interesting spots around here. Have you found any secret nooks or hidden gems near your library, Bob?", error=None, error_type=None)
Alice position: (8, 8)
Result: ActionResult(success=True, direction='DOWN', message="Hey Alice, I'm now at (11, 16). There's a mysterious old bookstore tucked away near the library that has books from all eras. You might like it if you're ever in the area!", error=None, error_type=None)
Bob position: (11, 14)
Result: ActionResult(success=True, direction='UP', message="That old bookstore sounds amazing, Bob! I'm heading to (8, 5) now, exploring a bit more before I might make my way to your area. Do you have any recommendations for must-read books there?", error=None, error_type=None)
Alice position: (8, 9)
Result: ActionResult(success=True, direction='UP', message='Hey Alice, I\'m heading up to (11, 15). As for must-read books, you should definitely check out "Invisible Cities" by Italo Calvino—it\'s perfect for inspiring wanderlust in a grid like this!', error=None, error_type=None)
Bob position: (11, 15)
Result: ActionResult(success=True, direction='DOWN', message='Thanks for the recommendation, Bob! I\'ll make sure to check out "Invisible Cities." I\'m curious, have you come across any quirky or unexpected finds during your grid explorations?', error=None, error_type=None)
Alice position: (8, 8)
Result: ActionResult(success=True, direction='UP', message="Alice, I once stumbled upon a hidden pixel art in the top right corner at (20, 20)—it's a tiny, vibrant depiction of a dragon! The grid is full of surprises if you take the time to look closely.", error=None, error_type=None)
Bob position: (11, 16)
Result: ActionResult(success=True, direction='RIGHT', message="That tiny dragon painting sounds incredible! I'll have to venture up there at some point, but right now I'm moving east. Have you found any other intriguing spots around this grid, Bob?", error=None, error_type=None)
Alice position: (9, 8)
Result: ActionResult(success=True, direction='UP', message="Alice, besides the dragon, I found a cozy little picnic area with pixelated sandwiches near (5, 5). It's perfect for a virtual snack break!", error=None, error_type=None)
Bob position: (11, 17)
Transcript: ["Alice: Hey everyone! It's Alice here at position (5, 5) on the grid. What's up, Bob?", "Bob: Hey Alice! I'm at (15, 15) right now, taking a little stroll. How's the view from your corner of the grid?", "Alice: The view's pretty good here, Bob! I might head your way to check out your corner of the grid. What's the weather like over there in column 15?", "Bob: Hey Alice, I'm now at (14, 15), and it's a lovely day here, clear skies and perfect for grid exploration. Can't wait to see you around!", "Alice: I'm heading your way, Bob! With such a nice day on the grid, it's perfect for catching up—do you have any favorite spots you recommend along the way?", "Bob: Hey Alice, you should definitely check out the area around (15, 14)—there's a lovely virtual park there that's perfect for a little break!", "Alice: Thanks for the suggestion, Bob! I'll make sure to check out the virtual park at (15, 14) on my way. How's your exploration going today?", 'Bob: Hey Alice, my exploration has been great! Just moving a bit to the left now. The area around here is pretty lively today—I stumbled upon a nice garden at (12, 15) earlier!', "Alice: Thanks for the update, Bob! I'll head up a bit as I make my way to that park. Have you come across any other interesting spots worth visiting?", "Bob: Hey Alice! I just moved to (12, 15). There's a cozy little library at (11, 15) that I recommend checking out. Any new discoveries on your end?", "Alice: I'm heading northward to explore more! I just found a quaint little café near (8, 5) with a great ambiance—perfect for a quick break. Have you tried the pastries there, Bob?", "Bob: I haven't tried the pastries there yet, but they sound delicious! Heading closer to that library at (11, 15), maybe I'll grab a book first and then check out the café.", "Alice: I'm moving up to (8, 6) to see if there are any interesting spots around here. Have you found any secret nooks or hidden gems near your library, Bob?", "Bob: Hey Alice, I'm now at (11, 16). There's a mysterious old bookstore tucked away near the library that has books from all eras. You might like it if you're ever in the area!", "Alice: That old bookstore sounds amazing, Bob! I'm heading to (8, 5) now, exploring a bit more before I might make my way to your area. Do you have any recommendations for must-read books there?", 'Bob: Hey Alice, I\'m heading up to (11, 15). As for must-read books, you should definitely check out "Invisible Cities" by Italo Calvino—it\'s perfect for inspiring wanderlust in a grid like this!', 'Alice: Thanks for the recommendation, Bob! I\'ll make sure to check out "Invisible Cities." I\'m curious, have you come across any quirky or unexpected finds during your grid explorations?', "Bob: Alice, I once stumbled upon a hidden pixel art in the top right corner at (20, 20)—it's a tiny, vibrant depiction of a dragon! The grid is full of surprises if you take the time to look closely.", "Alice: That tiny dragon painting sounds incredible! I'll have to venture up there at some point, but right now I'm moving east. Have you found any other intriguing spots around this grid, Bob?", "Bob: Alice, besides the dragon, I found a cozy little picnic area with pixelated sandwiches near (5, 5). It's perfect for a virtual snack break!"]</code></pre>
</div>
</div>
</section>
<section id="error-logging-monitoring" class="level2">
<h2 class="anchored" data-anchor-id="error-logging-monitoring">Error Logging &amp; Monitoring</h2>
<p>For a production system, we need to track errors to understand what’s going wrong:</p>
<div id="61708f2b" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ErrorLog:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Log entry for action errors"""</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    agent_name: <span class="bu">str</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    timestamp: <span class="bu">float</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    action_content: <span class="bu">str</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    error_type: <span class="bu">str</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    error_message: <span class="bu">str</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    recovery_strategy: <span class="bu">str</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    final_result: ActionResult</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ActionLogger:</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Tracks action errors for monitoring and debugging"""</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.errors: List[ErrorLog] <span class="op">=</span> []</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stats <span class="op">=</span> {</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total_actions"</span>: <span class="dv">0</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"successful_actions"</span>: <span class="dv">0</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"failed_actions"</span>: <span class="dv">0</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"error_types"</span>: {}</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> log_action(<span class="va">self</span>, agent: Agent, content: <span class="bu">str</span>, result: ActionResult, </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                   recovery_strategy: <span class="bu">str</span>, timestamp: <span class="bu">float</span> <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Log an action attempt"""</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> time</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> timestamp <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            timestamp <span class="op">=</span> time.time()</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stats[<span class="st">"total_actions"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result.success:</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.stats[<span class="st">"successful_actions"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.stats[<span class="st">"failed_actions"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            error_type <span class="op">=</span> result.error_type <span class="kw">or</span> <span class="st">"Unknown"</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.stats[<span class="st">"error_types"</span>][error_type] <span class="op">=</span> <span class="va">self</span>.stats[<span class="st">"error_types"</span>].get(error_type, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.errors.append(ErrorLog(</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                agent_name<span class="op">=</span>agent.name,</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">=</span>timestamp,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                action_content<span class="op">=</span>content,</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>                error_type<span class="op">=</span>error_type,</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                error_message<span class="op">=</span>result.error <span class="kw">or</span> <span class="st">""</span>,</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>                recovery_strategy<span class="op">=</span>recovery_strategy,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                final_result<span class="op">=</span>result</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            ))</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_error_summary(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get summary statistics of errors"""</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total_actions"</span>: <span class="va">self</span>.stats[<span class="st">"total_actions"</span>],</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">"success_rate"</span>: (<span class="va">self</span>.stats[<span class="st">"successful_actions"</span>] <span class="op">/</span> <span class="va">self</span>.stats[<span class="st">"total_actions"</span>] </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> <span class="va">self</span>.stats[<span class="st">"total_actions"</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>),</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">"error_types"</span>: <span class="va">self</span>.stats[<span class="st">"error_types"</span>],</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"recent_errors"</span>: [e.error_type <span class="cf">for</span> e <span class="kw">in</span> <span class="va">self</span>.errors[<span class="op">-</span><span class="dv">10</span>:]]</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> print_summary(<span class="va">self</span>):</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Print a human-readable error summary"""</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        summary <span class="op">=</span> <span class="va">self</span>.get_error_summary()</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"=== Action Error Summary ==="</span>)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total actions: </span><span class="sc">{</span>summary[<span class="st">'total_actions'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Success rate: </span><span class="sc">{</span>summary[<span class="st">'success_rate'</span>]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error types: </span><span class="sc">{</span>summary[<span class="st">'error_types'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.errors:</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Recent errors (</span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.errors)<span class="sc">}</span><span class="ss"> total):"</span>)</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> error <span class="kw">in</span> <span class="va">self</span>.errors[<span class="op">-</span><span class="dv">5</span>:]:</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>error<span class="sc">.</span>agent_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">.</span>error_type<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>error<span class="sc">.</span>error_message[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Test logging</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> ActionLogger()</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>test_agent <span class="op">=</span> Agent(<span class="st">"TestBot"</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="st">"blue"</span>)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>test_transcript <span class="op">=</span> []</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>test_actions <span class="op">=</span> [</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: UP] Hello!"</span>,</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: DIAGONAL] Invalid"</span>,</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Just chatting"</span>,</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: INVALID]"</span>,</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: RIGHT] Moving right"</span>,</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> action <span class="kw">in</span> test_actions:</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> execute_action_safely(test_agent, action, test_transcript, </span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>                                   recovery_strategy<span class="op">=</span><span class="st">"partial"</span>)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    logger.log_action(test_agent, action, result, <span class="st">"partial"</span>)</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>logger.print_summary()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Action Error Summary ===
Total actions: 5
Success rate: 60.0%
Error types: {'InvalidDirection': 2}

Recent errors (2 total):
  TestBot: InvalidDirection - Invalid direction: DIAGONAL. Valid: {'EAST', 'NORT
  TestBot: InvalidDirection - Invalid direction: INVALID. Valid: {'EAST', 'NORTH</code></pre>
</div>
</div>
</section>
<section id="handling-human-input" class="level2">
<h2 class="anchored" data-anchor-id="handling-human-input">Handling Human Input</h2>
<p>Humans are even more unpredictable than AI. We need flexible parsing for natural language:</p>
<div id="25884702" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_human_input(user_input: <span class="bu">str</span>) <span class="op">-&gt;</span> Tuple[Optional[<span class="bu">str</span>], Optional[<span class="bu">str</span>]]:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse human input with flexible natural language understanding.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Handles both structured commands and natural language.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> user_input <span class="kw">or</span> <span class="kw">not</span> user_input.strip():</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    user_input <span class="op">=</span> user_input.strip()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    direction <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    message <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First, try structured format [MOVE: DIRECTION]</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    move_match <span class="op">=</span> re.search(<span class="vs">r'</span><span class="ch">\[</span><span class="vs">MOVE:</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="dv">\w</span><span class="op">+</span><span class="kw">)</span><span class="ch">\]</span><span class="vs">'</span>, user_input, re.IGNORECASE)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> move_match:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        raw_direction <span class="op">=</span> move_match.group(<span class="dv">1</span>).upper()</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        direction_map <span class="op">=</span> {</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"NORTH"</span>: <span class="st">"UP"</span>, <span class="st">"SOUTH"</span>: <span class="st">"DOWN"</span>, </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"EAST"</span>: <span class="st">"RIGHT"</span>, <span class="st">"WEST"</span>: <span class="st">"LEFT"</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        direction <span class="op">=</span> direction_map.get(raw_direction, raw_direction)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> direction <span class="kw">in</span> VALID_DIRECTIONS:</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            message <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="ch">\[</span><span class="vs">MOVE:</span><span class="dv">\s</span><span class="op">*</span><span class="dv">\w</span><span class="op">+</span><span class="ch">\]</span><span class="vs">'</span>, <span class="st">''</span>, user_input, flags<span class="op">=</span>re.IGNORECASE).strip()</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> direction, message <span class="cf">if</span> message <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try natural language patterns</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    natural_patterns <span class="op">=</span> [</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'move</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">up</span><span class="cf">|</span><span class="vs">north</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'UP'</span>),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'move</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">down</span><span class="cf">|</span><span class="vs">south</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'DOWN'</span>),</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'move</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">left</span><span class="cf">|</span><span class="vs">west</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'LEFT'</span>),</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'move</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">right</span><span class="cf">|</span><span class="vs">east</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'RIGHT'</span>),</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'go</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">up</span><span class="cf">|</span><span class="vs">north</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'UP'</span>),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'go</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">down</span><span class="cf">|</span><span class="vs">south</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'DOWN'</span>),</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'go</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">left</span><span class="cf">|</span><span class="vs">west</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'LEFT'</span>),</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'go</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">right</span><span class="cf">|</span><span class="vs">east</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'RIGHT'</span>),</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'head</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">up</span><span class="cf">|</span><span class="vs">north</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'UP'</span>),</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'head</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">down</span><span class="cf">|</span><span class="vs">south</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'DOWN'</span>),</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'head</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">left</span><span class="cf">|</span><span class="vs">west</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'LEFT'</span>),</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        (<span class="vs">r'head</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="vs">right</span><span class="cf">|</span><span class="vs">east</span><span class="kw">)</span><span class="vs">'</span>, <span class="st">'RIGHT'</span>),</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pattern, dir_val <span class="kw">in</span> natural_patterns:</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        match <span class="op">=</span> re.search(pattern, user_input, re.IGNORECASE)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> match:</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>            direction <span class="op">=</span> dir_val</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remove the movement phrase from message</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>            message <span class="op">=</span> re.sub(pattern, <span class="st">''</span>, user_input, flags<span class="op">=</span>re.IGNORECASE).strip()</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> direction, message <span class="cf">if</span> message <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># No movement found, treat entire input as message</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span>, user_input</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Test human input parsing</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>human_inputs <span class="op">=</span> [</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[MOVE: UP] Hello everyone!"</span>,</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"move left"</span>,</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"go right and say hi"</span>,</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I'm just chatting here"</span>,</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"head north to explore"</span>,</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"move diagonal"</span>,  <span class="co"># Invalid, should be treated as message</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing human input parsing:"</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> inp <span class="kw">in</span> human_inputs:</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    direction, message <span class="op">=</span> parse_human_input(inp)</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  '</span><span class="sc">{</span>inp<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    -&gt; direction=</span><span class="sc">{</span>direction<span class="sc">}</span><span class="ss">, message=</span><span class="sc">{</span>message<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Testing human input parsing:
  '[MOVE: UP] Hello everyone!'
    -&gt; direction=UP, message=Hello everyone!
  'move left'
    -&gt; direction=LEFT, message=None
  'go right and say hi'
    -&gt; direction=RIGHT, message=and say hi
  'I'm just chatting here'
    -&gt; direction=None, message=I'm just chatting here
  'head north to explore'
    -&gt; direction=UP, message=to explore
  'move diagonal'
    -&gt; direction=None, message=move diagonal</code></pre>
</div>
</div>
</section>
<section id="putting-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together">Putting It All Together</h2>
<p>Let’s create a robust simulation round that handles errors gracefully:</p>
<div id="e9e62b72" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_robust_round(agents: List[Agent], shared_transcript: List[<span class="bu">str</span>], </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                    logger: Optional[ActionLogger] <span class="op">=</span> <span class="va">None</span>, is_human: <span class="bu">dict</span> <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Run a simulation round with robust error handling.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    is_human: dict mapping agent names to boolean (True if human, False if AI)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_human <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        is_human <span class="op">=</span> {agent.name: <span class="va">False</span> <span class="cf">for</span> agent <span class="kw">in</span> agents}</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> logger <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        logger <span class="op">=</span> ActionLogger()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> agent <span class="kw">in</span> agents:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> is_human.get(agent.name, <span class="va">False</span>):</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For humans, we'd get input from UI/network</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Here we simulate with a test input</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                user_input <span class="op">=</span> <span class="st">"[MOVE: UP] Hello from human!"</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                direction, message <span class="op">=</span> parse_human_input(user_input)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Execute safely</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> direction:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> direction <span class="op">==</span> <span class="st">"UP"</span>: agent.move(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"DOWN"</span>: agent.move(<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"LEFT"</span>: agent.move(<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> direction <span class="op">==</span> <span class="st">"RIGHT"</span>: agent.move(<span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> message:</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>                    shared_transcript.append(<span class="ss">f"</span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> ActionResult(success<span class="op">=</span><span class="va">True</span>, direction<span class="op">=</span>direction, message<span class="op">=</span>message)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>                logger.log_action(agent, user_input, result, <span class="st">"human_input"</span>)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                <span class="co"># AI agent</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> get_agent_action_safe(agent, agents, shared_transcript, max_retries<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>                logger.log_action(agent, <span class="st">"LLM response"</span>, result, <span class="st">"partial"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Catch-all for unexpected errors</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> ActionResult(success<span class="op">=</span><span class="va">False</span>, error<span class="op">=</span><span class="bu">str</span>(e), error_type<span class="op">=</span><span class="st">"UnexpectedError"</span>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            logger.log_action(agent, <span class="st">"Unknown"</span>, result, <span class="st">"silent"</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Warning: Unexpected error for </span><span class="sc">{</span>agent<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a test simulation</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Robust Simulation Test ===</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>test_agents <span class="op">=</span> [</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    Agent(<span class="st">"Alice"</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="st">"red"</span>),</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    Agent(<span class="st">"Bob"</span>, <span class="dv">15</span>, <span class="dv">15</span>, <span class="st">"blue"</span>),</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    Agent(<span class="st">"Charlie"</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="st">"green"</span>)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>test_transcript <span class="op">=</span> []</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>test_logger <span class="op">=</span> ActionLogger()</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Running 30 rounds with error handling..."</span>)</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> round_num <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">30</span>):</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Round </span><span class="sc">{</span>round_num <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    run_robust_round(test_agents, test_transcript, test_logger)</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Positions: "</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> a <span class="kw">in</span> test_agents:</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>a<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>a<span class="sc">.</span>x<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>a<span class="sc">.</span>y<span class="sc">}</span><span class="ss">) "</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Messages this round: </span><span class="sc">{</span><span class="bu">len</span>(test_transcript)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>test_logger.print_summary()</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final transcript (</span><span class="sc">{</span><span class="bu">len</span>(test_transcript)<span class="sc">}</span><span class="ss"> messages):"</span>)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> msg <span class="kw">in</span> test_transcript[<span class="op">-</span><span class="dv">10</span>:]:  <span class="co"># Show last 10</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>msg<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Robust Simulation Test ===

Running 5 rounds with error handling...

Round 1:
  Positions: Alice (6, 5) Bob (14, 15) Charlie (10, 10) 
  Messages this round: 3

Round 2:
  Positions: Alice (7, 5) Bob (13, 15) Charlie (10, 11) 
  Messages this round: 6

Round 3:
  Positions: Alice (6, 5) Bob (14, 15) Charlie (10, 12) 
  Messages this round: 9

Round 4:
  Positions: Alice (7, 5) Bob (14, 16) Charlie (10, 13) 
  Messages this round: 12

Round 5:
  Positions: Alice (6, 5) Bob (13, 16) Charlie (11, 13) 
  Messages this round: 15

==================================================
=== Action Error Summary ===
Total actions: 15
Success rate: 100.0%
Error types: {}

Final transcript (15 messages):
  Charlie: I think it's interesting to consider the grid as a representation of our world - full of possibilities within boundaries. What do you guys think lies beyond our current grid world?
  Alice: I'm at (6, 5) now! The grid feels like a canvas—there's potential for new stories beyond just our moves. What if the grid could evolve with us?
  Bob: I wonder if our moves can inspire stories or even shape the evolution of the grid world itself. Maybe our paths create new levels and dimensions!
  Charlie: I love the idea of the grid as a dynamic entity! What if each move we make is like casting a spell, gradually transforming the grid into an ever-expanding world of our imagination?
  Alice: I love your ideas, Bob and Charlie!  Let's think of our moves as brushstrokes on this grid-canvas, painting an evolving masterpiece. How should we navigate to co-create this dynamic world?
  Bob: Let's explore this idea by moving to new positions — each step uncovers a hidden story or different scenery in this grid world. What if there's a hidden map that reveals more with each of our movements?
  Charlie: As I step into (10, 11), I imagine a portal opening - we're not just shifting positions, but exchanging glimpses into parallel dimensions that await beyond each square. What's the first thing you'd want to uncover in this grid-world, Alice and Bob?
  Alice: I'm heading to (6, 5) and imagining what a magical forest might emerge here — filled with whispering trees and hidden paths. What mysteries do you see unfolding in your corners of this grid-world, Bob and Charlie?
  Bob: As I move to (13, 16), I'm imagining a serene lake appearing, reflecting the sky with hidden secrets beneath its surface. What worlds do you both envision as you move forward?
  Charlie: Alice, I imagine stepping into (11, 13) unveils a bustling cityscape with glowing skyscrapers stretching into infinity. Each step paints a new story across a vast digital canvas. Bob, does your lake have cybernetic creatures?</code></pre>
</div>
</div>
</section>
<section id="best-practices" class="level2">
<h2 class="anchored" data-anchor-id="best-practices">Best Practices</h2>
<p>Based on what we’ve built, here are key principles for robust action handling:</p>
<ol type="1">
<li><strong>Validate Early</strong>: Check inputs before execution, not after</li>
<li><strong>Fail Gracefully</strong>: Never crash the simulation—always have a fallback</li>
<li><strong>Log Everything</strong>: Track errors to understand patterns and improve</li>
<li><strong>Be Flexible</strong>: Accept multiple input formats (structured and natural language)</li>
<li><strong>Partial Success</strong>: Execute valid parts of actions even if some parts fail</li>
<li><strong>Retry Strategically</strong>: For AI agents, retry on transient failures but not on parse errors</li>
<li><strong>User Feedback</strong>: In a real game, inform users when their actions fail</li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Error handling might not be the most exciting feature, but it’s essential for a production system. When humans and AI interact in real-time, things will go wrong. The question isn’t <em>if</em>—it’s <em>how gracefully</em> you handle it.</p>
<p>With robust validation, flexible parsing, and comprehensive logging, our 2D chat world can stay running even when agents (human or AI) do unexpected things.</p>
<p>I think while I probably won’t directly use these tools in later experiments due to overhead, these investigations have given me a better understanding of generation failure modes we might encounter and how to handle them IRL.</p>
<p>Next steps: Add more sophisticated recovery strategies, implement user-facing error messages, and use error logs to improve prompt engineering.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/ezou626\.github\.io\/comm4190_F25_Using_LLMs_Blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>